name: Release (macOS arm64 + x64)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (example: v0.1.0)'
        required: true
        type: string

permissions:
  contents: write

env:
  TAG_NAME: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}

jobs:
  build-macos:
    name: Build ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-14
            target: aarch64-apple-darwin
            arch: arm64
          - runner: macos-15-intel
            target: x86_64-apple-darwin
            arch: x64

    steps:
      - name: Checkout tag source
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TAG_NAME }}
          fetch-depth: 0

      - name: Ensure Cargo.lock for legacy tags
        run: |
          if [ ! -f src-tauri/Cargo.lock ]; then
            echo "Cargo.lock missing in ${TAG_NAME}, restoring from main"
            git fetch --depth 1 origin main
            git show FETCH_HEAD:src-tauri/Cargo.lock > src-tauri/Cargo.lock
          fi
          test -f src-tauri/Cargo.lock

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: pnpm

      - name: Install frontend dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Detect Apple signing and notarization mode
        id: signing
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          REQUIRED_VARS=(
            APPLE_CERTIFICATE
            APPLE_CERTIFICATE_PASSWORD
            APPLE_SIGNING_IDENTITY
            APPLE_ID
            APPLE_PASSWORD
            APPLE_TEAM_ID
          )

          MISSING_VARS=()
          for VAR_NAME in "${REQUIRED_VARS[@]}"; do
            if [ -z "${!VAR_NAME}" ]; then
              MISSING_VARS+=("${VAR_NAME}")
            fi
          done

          if [ "${#MISSING_VARS[@]}" -eq 0 ]; then
            echo "enabled=true" >> "$GITHUB_OUTPUT"
            echo "Apple signing/notarization: enabled"
          else
            echo "enabled=false" >> "$GITHUB_OUTPUT"
            echo "::warning::Missing Apple secrets: ${MISSING_VARS[*]}"
            echo "::warning::Fallback to unsigned build (release will work without notarization)."
          fi

      - name: Build Tauri app (signed/notarized)
        if: steps.signing.outputs.enabled == 'true'
        run: pnpm exec tauri build --target ${{ matrix.target }}
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      - name: Build Tauri app (unsigned fallback)
        if: steps.signing.outputs.enabled != 'true'
        run: pnpm exec tauri build --target ${{ matrix.target }}

      - name: Collect release assets
        run: |
          mkdir -p release-assets
          rm -f release-assets/*

          if [ -d "src-tauri/target/${{ matrix.target }}/release/bundle" ]; then
            BUNDLE_DIR="src-tauri/target/${{ matrix.target }}/release/bundle"
          elif [ -d "src-tauri/target/release/bundle" ]; then
            BUNDLE_DIR="src-tauri/target/release/bundle"
          else
            echo "Bundle directory not found"
            find src-tauri/target -maxdepth 5 -type d -name bundle || true
            exit 1
          fi

          echo "Using bundle directory: ${BUNDLE_DIR}"

          APP_PATH="$(find "${BUNDLE_DIR}" -maxdepth 4 -type d -name "*.app" | head -n 1)"
          if [ -z "${APP_PATH}" ]; then
            echo "No .app bundle found under ${BUNDLE_DIR}"
            find "${BUNDLE_DIR}" -maxdepth 4 -print
            exit 1
          fi

          APP_NAME="$(basename "${APP_PATH}" .app)"
          VERSION="${TAG_NAME#v}"
          if [ "${{ matrix.target }}" = "aarch64-apple-darwin" ]; then
            ARCH_SUFFIX="aarch64"
          else
            ARCH_SUFFIX="x64"
          fi
          SAFE_APP_NAME="$(echo "${APP_NAME}" | tr ' ' '_')"
          DMG_NAME="${SAFE_APP_NAME}_${VERSION}_${ARCH_SUFFIX}.dmg"
          DMG_PATH="release-assets/${DMG_NAME}"

          PREBUILT_DMG="$(find "${BUNDLE_DIR}" -maxdepth 5 -type f -name "${SAFE_APP_NAME}_${VERSION}_${ARCH_SUFFIX}.dmg" | head -n 1)"
          if [ -z "${PREBUILT_DMG}" ]; then
            PREBUILT_DMG="$(find "${BUNDLE_DIR}" -maxdepth 5 -type f -name "*.dmg" | head -n 1)"
          fi
          if [ -n "${PREBUILT_DMG}" ]; then
            echo "Using prebuilt DMG: ${PREBUILT_DMG}"
            cp "${PREBUILT_DMG}" "${DMG_PATH}"
          else
            echo "No prebuilt DMG found, creating one from ${APP_PATH}"
            rm -f "${DMG_PATH}"
            hdiutil create -volname "${APP_NAME}" -srcfolder "${APP_PATH}" -ov -format UDZO "${DMG_PATH}"
          fi

          find "${BUNDLE_DIR}" -type f \
            \( -name "*.app.tar.gz" -o -name "*.zip" \) \
            -exec cp {} release-assets/ \;

          if [ "${{ steps.signing.outputs.enabled }}" != "true" ]; then
            printf '%s\n' \
              'This macOS build is unsigned and not notarized.' \
              'If Gatekeeper blocks launch, run:' \
              'xattr -dr com.apple.quarantine "/Applications/Claude Session Switch.app"' \
              > release-assets/UNSIGNED_BUILD_NOTICE.txt
          fi

          ls -lah release-assets

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ matrix.arch }}
          path: release-assets/*
          if-no-files-found: error

  publish-release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: build-macos

    steps:
      - name: Download arm64 artifacts
        uses: actions/download-artifact@v4
        with:
          name: app-arm64
          path: release-assets/arm64

      - name: Download x64 artifacts
        uses: actions/download-artifact@v4
        with:
          name: app-x64
          path: release-assets/x64

      - name: Generate SHA256 checksums
        run: |
          find release-assets -type f -print
          (cd release-assets && find arm64 x64 -type f -maxdepth 2 -print0 | xargs -0 sha256sum > SHA256SUMS.txt)

      - name: Create release with auto notes
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: ${{ env.TAG_NAME }}
          generate_release_notes: true
          draft: false
          prerelease: false
          files: |
            release-assets/arm64/*
            release-assets/x64/*
            release-assets/SHA256SUMS.txt
